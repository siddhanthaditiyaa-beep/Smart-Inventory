<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shop | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">
  <h1>ðŸ›’ Shop</h1>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
    <button onclick="logout()" class="login-btn" style="width:120px">
      Logout
    </button>
  </div>

  <!-- ITEMS -->
  <div id="items" class="grid"></div>

  <!-- CART -->
  <h2 style="margin-top:30px;">ðŸ§º Your Cart</h2>
  <ul id="cart" style="padding-left:0;"></ul>

  <!-- Desktop checkout -->
  <button id="desktopCheckout" onclick="checkout()" style="margin-top:10px;">
    Checkout
  </button>

  <!-- ORDER HISTORY -->
  <h2 style="margin-top:40px;">ðŸ“¦ My Orders</h2>
  <div id="orders"></div>
</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "customer") {
  window.location.href = "login.html";
}

let cart = {};
let prices = {};

/* ================= LOAD ITEMS ================= */
async function loadItems() {
  const res = await fetch("/shop-items", {
    headers: { Authorization: token }
  });

  const data = await res.json();
  const container = document.getElementById("items");
  container.innerHTML = "";
  prices = {};

  Object.keys(data).forEach(key => {
    const item = data[key];
    prices[key] = item.price;

    container.innerHTML += `
      <div class="item-card">
        <h3>${item.name}</h3>
        <p style="font-weight:bold;">â‚¹ ${item.price}</p>

        ${item.warning ? `<span class="badge">Only ${item.warning} left</span>` : ""}

        <button ${item.canBuy ? "" : "disabled"} onclick="add('${key}')">
          ${item.canBuy ? "Add to Cart" : "Out of Stock"}
        </button>
      </div>
    `;
  });
}

/* ================= CART ================= */
function add(key) {
  cart[key] = (cart[key] || 0) + 1;
  renderCart();
}

function remove(key) {
  cart[key]--;
  if (cart[key] <= 0) delete cart[key];
  renderCart();
}

function renderCart() {
  const ul = document.getElementById("cart");
  const cartInfo = document.getElementById("cartInfo");

  ul.innerHTML = "";
  let totalItems = 0;
  let totalPrice = 0;

  Object.keys(cart).forEach(key => {
    totalItems += cart[key];
    totalPrice += cart[key] * prices[key];

    ul.innerHTML += `
      <li style="
        list-style:none;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:10px;
        margin-bottom:8px;
        background:#f8f9ff;
        border-radius:8px;
      ">
        <span><b>${key}</b> Ã— ${cart[key]}</span>
        <button onclick="remove('${key}')" style="padding:6px 10px;">âž–</button>
      </li>
    `;
  });

  if (cartInfo) {
    cartInfo.innerText = `ðŸ§º ${totalItems} items | â‚¹${totalPrice}`;
  }
}

/* ================= CHECKOUT ================= */
function checkout() {
  if (Object.keys(cart).length === 0) {
    alert("Cart is empty");
    return;
  }

  localStorage.setItem("pendingCart", JSON.stringify(cart));
  window.location.href = "payment.html";
}

/* ================= ORDER HISTORY ================= */
async function loadOrders() {
  const res = await fetch("/customer/orders", {
    headers: { Authorization: token }
  });

  const orders = await res.json();
  const container = document.getElementById("orders");
  container.innerHTML = "";

  if (!orders.length) {
    container.innerHTML = "<p>No past orders</p>";
    return;
  }

  orders.forEach(o => {
    container.innerHTML += `
      <div style="
        background:#fafafa;
        border-radius:12px;
        padding:14px;
        margin-bottom:14px;
      ">
        <strong>${o.time}</strong>
        <ul style="padding-left:16px;">
          ${o.items.map(i => `<li>${i.name} Ã— ${i.qty} = â‚¹${i.subtotal}</li>`).join("")}
        </ul>
        <strong>Total: â‚¹${o.totalAmount}</strong>
      </div>
    `;
  });
}

/* ================= LOGOUT ================= */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= INIT ================= */
loadItems();
loadOrders();
setInterval(loadItems, 3000);
setInterval(loadOrders, 5000);
</script>

<!-- ðŸ“± Mobile Cart Bar -->
<div id="mobileCartBar">
  <span id="cartInfo">ðŸ§º 0 items | â‚¹0</span>
  <button onclick="checkout()">Checkout</button>
</div>

</body>
</html>
