<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="admin-body">

  <button class="dark-toggle" onclick="toggleDarkMode()">ğŸŒ™</button>

<div class="admin-header">
  <h1>ğŸ“Š Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="admin-container">

  <!-- ADD ITEM -->
  <div class="card">
    <h2>â• Add Item</h2>
    <input id="itemName" placeholder="Item name">
    <input id="itemStock" type="number" placeholder="Initial stock">
    <input id="itemPrice" type="number" placeholder="Price" min="0">
    <button onclick="addItem()">Add Item</button>
  </div>

  <!-- INVENTORY -->
  <div class="card">
    <h2>ğŸ“¦ Inventory</h2>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Stock</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>

  <!-- STOCK GRAPH -->
  <div class="card">
    <h2>ğŸ“ˆ Stock Graph</h2>
    <canvas id="stockChart" height="220"></canvas>
  </div>

  <!-- REVENUE ANALYTICS -->
  <div class="card">
    <h2>ğŸ’° Revenue Analytics</h2>
    <p><strong>Total Revenue:</strong> â‚¹<span id="totalRevenue">0</span></p>
    <p><strong>Total Orders:</strong> <span id="totalOrders">0</span></p>
    <canvas id="revenueChart" height="220"></canvas>
  </div>

  <button class="danger-btn" onclick="resetLogs()">ğŸ§¹ Reset Logs & Stocks</button>

  <!-- FORECASTING LOGS -->
  <div class="card">
    <h2>ğŸ¤– Forecasting Logs</h2>
    <ul id="forecastingLogs"></ul>
  </div>

  <!-- MONITORING LOGS -->
  <div class="card">
    <h2>ğŸ” Monitoring Logs</h2>
    <ul id="monitoringLogs"></ul>
  </div>

  <!-- ORDERS -->
  <div class="card">
    <h2>ğŸ§¾ Orders & Bills</h2>
    <div id="orders"></div>
  </div>

</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "admin") location.href = "login.html";

let chart, revenueChart;
let isEditing = false;

/* LOAD ADMIN */
async function loadAdmin() {
  if (isEditing) return;
  const res = await fetch("/admin-data", { headers: { Authorization: token }});
  const data = await res.json();
  renderInventory(data.inventory);
  renderLogs(data.forecasting, "forecastingLogs");
  renderLogs(data.monitoring, "monitoringLogs");
  renderChart(data.inventory);
}

/* INVENTORY */
function renderInventory(items) {
  inventoryTable.innerHTML = "";
  items.forEach(i => {
    inventoryTable.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td><input type="number" value="${i.stock}" min="0"
          onfocus="pauseRefresh()"
          onblur="saveStock('${i.key}', this.value)"></td>
        <td><input type="number" value="${i.price ?? 0}" min="0"
          onfocus="pauseRefresh()"
          onblur="savePrice('${i.key}', this.value)"></td>
        <td><button class="delete-btn" onclick="deleteItem('${i.key}')">âœ–</button></td>
      </tr>`;
  });
}

async function saveStock(key, stock) {
  await fetch("/admin/update-stock", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ key, stock: Number(stock) })
  });
  resumeRefresh();
}

async function savePrice(key, price) {
  await fetch("/admin/update-price", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ key, price: Number(price) })
  });
  resumeRefresh();
}

function pauseRefresh(){ isEditing = true; }
function resumeRefresh(){
  isEditing = false;
  loadAdmin(); loadOrders(); loadAnalytics();
}

/* LOGS */
function renderLogs(logs, id) {
  document.getElementById(id).innerHTML =
    logs.length
      ? logs.map(l => `<li><b>${l.item}</b> â†’ ${l.stock}<br><small>${l.time}</small></li>`).join("")
      : "<li>No logs yet</li>";
}

/* STOCK CHART */
function renderChart(items) {
  chart.data.labels = items.map(i => i.name);
  chart.data.datasets[0].data = items.map(i => i.stock);
  chart.update();
}

/* ADD ITEM */
async function addItem() {
  await fetch("/admin/add-item", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({
      name: itemName.value.trim(),
      stock: Number(itemStock.value),
      price: Number(itemPrice.value)
    })
  });
  itemName.value = itemStock.value = itemPrice.value = "";
  loadAdmin();
}

/* DELETE ITEM */
async function deleteItem(key) {
  await fetch(`/admin/delete-item/${key}`, {
    method: "DELETE",
    headers: { Authorization: token }
  });
  loadAdmin();
}

/* ORDERS */
async function loadOrders() {
  if (isEditing) return;
  const res = await fetch("/admin/orders", { headers: { Authorization: token }});
  const orders = await res.json();
  ordersDiv.innerHTML = orders.length ? "" : "<p>No orders yet</p>";

  orders.forEach(o => {
    ordersDiv.innerHTML += `
      <div style="border:1px solid #ddd;padding:12px;margin-bottom:12px;">
        <b>${o.customer.fname} ${o.customer.lname}</b><br>
        <small>${o.customer.email}</small><br>
        <small>${o.time}</small><br><br>
        <ul>${o.items.map(i => `<li>${i.name} Ã— ${i.qty} = â‚¹${i.subtotal}</li>`).join("")}</ul>
        <b>Total: â‚¹${o.totalAmount}</b><br>
        <b>Status:</b>
        <span style="padding:4px 8px;border-radius:6px;color:white;
          background:${o.paymentStatus==="PAID"?"green":o.paymentStatus==="FAILED"?"red":"orange"}">
          ${o.paymentStatus}
        </span><br><br>

        <a href="/admin/invoice/${o._id}" target="_blank">
          <button>â¬‡ Invoice</button>
        </a>

        ${o.paymentStatus === "PAID" ? `
          <button onclick="refund('${o._id}')"
            style="background:#ff9800;margin-left:6px;">
            ğŸ”„ Refund
          </button>` : ""}
      </div>`;
  });
}

/* REFUND */
async function refund(orderId) {
  if (!confirm("Refund this order?")) return;
  await fetch("/admin/order-status", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ orderId, status: "REFUNDED" })
  });
  loadOrders(); loadAnalytics();
}

/* ANALYTICS */
async function loadAnalytics() {
  const res = await fetch("/admin/analytics", { headers: { Authorization: token }});
  const data = await res.json();
  totalRevenue.innerText = data.totalRevenue;
  totalOrders.innerText = data.totalOrders;

  revenueChart.data.labels = data.dailyRevenue.map(d => d.date);
  revenueChart.data.datasets[0].data = data.dailyRevenue.map(d => d.revenue);
  revenueChart.update();
}

/* RESET */
async function resetLogs() {
  if (!confirm("Clear logs, orders and reset stock?")) return;
  await fetch("/admin/reset-logs", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token }
  });
  loadAdmin(); loadOrders(); loadAnalytics();
}

/* LOGOUT */
async function logout() {
  await fetch("/logout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token })
  });
  localStorage.clear();
  location.href = "login.html";
}

/* INIT */
function initCharts() {
  chart = new Chart(stockChart, {
    type: "bar",
    data: { labels: [], datasets: [{ label: "Stock", data: [] }] }
  });

  revenueChart = new Chart(revenueChart, {
    type: "line",
    data: { labels: [], datasets: [{ label: "Revenue", data: [], borderColor:"#3ec6c6", tension:0.3 }] }
  });
}

initCharts();
loadAdmin(); loadOrders(); loadAnalytics();
setInterval(loadAdmin,3000);
setInterval(loadOrders,4000);
setInterval(loadAnalytics,5000);

/* =========================
   CUSTOMER ORDER HISTORY (PAID ONLY)
========================= */
app.get("/customer/orders", auth("customer"), async (req, res) => {
  try {
    const orders = await Order.find({
      "customer.email": req.user.email,
      paymentStatus: "PAID"
    }).sort({ _id: -1 });

    res.json(orders);
  } catch (err) {
    res.status(500).json({ message: "Failed to fetch orders" });
  }
});

</script>

<script>
function toggleDarkMode() {
  document.body.classList.toggle("dark");

  if (document.body.classList.contains("dark")) {
    localStorage.setItem("darkMode", "on");
  } else {
    localStorage.setItem("darkMode", "off");
  }
}

window.onload = () => {
  if (localStorage.getItem("darkMode") === "on") {
    document.body.classList.add("dark");
  }
};
</script>

</body>
</html>
