<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="admin-body">

<div class="admin-header">
  <h1>üìä Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="admin-container">

  <!-- ADD ITEM -->
  <div class="card">
    <h2>‚ûï Add Item</h2>
    <input id="itemName" placeholder="Item name">
    <input id="itemStock" type="number" placeholder="Initial stock">
    <input id="itemPrice" type="number" placeholder="Price" min="0">
    <button onclick="addItem()">Add Item</button>
  </div>

  <!-- INVENTORY -->
  <div class="card">
    <h2>üì¶ Inventory</h2>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Stock</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>

  <!-- STOCK GRAPH -->
  <div class="card">
    <h2>üìà Stock Graph</h2>
    <canvas id="stockChart" height="220"></canvas>
  </div>

  <button class="danger-btn" onclick="resetLogs()">üßπ Reset Logs & Stocks</button>

  <!-- FORECASTING LOGS -->
  <div class="card">
    <h2>ü§ñ Forecasting Logs</h2>
    <ul id="forecastingLogs"></ul>
  </div>

  <!-- MONITORING LOGS -->
  <div class="card">
    <h2>üîç Monitoring Logs</h2>
    <ul id="monitoringLogs"></ul>
  </div>

  <!-- üßæ ORDERS & BILLS -->
  <div class="card">
    <h2>üßæ Orders & Bills</h2>
    <div id="orders"></div>
  </div>

</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "admin") {
  window.location.href = "login.html";
}

let chart;
let isEditing = false;

/* ================= LOAD ADMIN DATA ================= */
async function loadAdmin() {
  if (isEditing) return;

  const res = await fetch("/admin-data", {
    headers: { Authorization: token }
  });

  const data = await res.json();

  renderInventory(data.inventory);
  renderLogs(data.forecasting, "forecastingLogs");
  renderLogs(data.monitoring, "monitoringLogs");
  renderChart(data.inventory);
}

/* ================= INVENTORY ================= */
function renderInventory(items) {
  const table = document.getElementById("inventoryTable");
  table.innerHTML = "";

  items.forEach(item => {
    table.innerHTML += `
      <tr>
        <td>${item.name}</td>

        <td>
          <input
            type="number"
            value="${item.stock}"
            min="0"
            style="width:70px"
            onfocus="pauseRefresh()"
            onblur="saveStock('${item.key}', this.value)"
          >
        </td>

        <td>
          <input
            type="number"
            value="${item.price ?? 0}"
            min="0"
            style="width:70px"
            onfocus="pauseRefresh()"
            onblur="savePrice('${item.key}', this.value)"
          >
        </td>

        <td>
          <button class="delete-btn" onclick="deleteItem('${item.key}')">‚úñ</button>
        </td>
      </tr>
    `;
  });
}

/* ================= SAVE STOCK ================= */
async function saveStock(key, stock) {
  await fetch("/admin/update-stock", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ key, stock: Number(stock) })
  });
  resumeRefresh();
}

/* ================= SAVE PRICE ================= */
async function savePrice(key, price) {
  await fetch("/admin/update-price", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ key, price: Number(price) })
  });
  resumeRefresh();
}

/* ================= PAUSE / RESUME REFRESH ================= */
function pauseRefresh() {
  isEditing = true;
}

function resumeRefresh() {
  isEditing = false;
  loadAdmin();
  loadOrders();
}

/* ================= LOGS ================= */
function renderLogs(logs, id) {
  const ul = document.getElementById(id);
  ul.innerHTML = "";

  if (logs.length === 0) {
    ul.innerHTML = "<li>No logs yet</li>";
    return;
  }

  logs.forEach(l => {
    ul.innerHTML += `
      <li>
        <strong>${l.item}</strong> ‚Üí ${l.stock}
        <br><small>${l.time}</small>
      </li>
    `;
  });
}

let pulseInterval = null;
let pulseState = true;
const shownZeroStock = new Set();

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 3000);
}

/* ================= GRAPH ================= */
function renderChart(items) {
  chart.data.labels = items.map(i => i.name);
  chart.data.datasets[0].data = items.map(i => i.stock);

  chart.data.datasets[0].backgroundColor = items.map(i => {
    if (i.stock === 0) return pulseState ? "#ff0000" : "#ffb3b3";
    if (i.stock < 3) return "#ff4d4d";
    return "#3ec6c6";
  });

  chart.update("none");

  items.forEach(item => {
    if (item.stock === 0 && !shownZeroStock.has(item.name)) {
      showToast(`üö® ${item.name} is OUT OF STOCK!`);
      shownZeroStock.add(item.name);
    }
  });

  const hasZeroStock = items.some(i => i.stock === 0);

  if (hasZeroStock && !pulseInterval) {
    pulseInterval = setInterval(() => {
      pulseState = !pulseState;
      renderChart(items);
    }, 600);
  }

  if (!hasZeroStock && pulseInterval) {
    clearInterval(pulseInterval);
    pulseInterval = null;
    shownZeroStock.clear();
  }
}

/* ================= ADD ITEM ================= */
async function addItem() {
  const name = itemName.value.trim();
  const stock = Number(itemStock.value);
  const price = Number(itemPrice.value);

  if (!name || stock < 0 || price < 0) {
    return alert("Invalid input");
  }

  await fetch("/admin/add-item", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ name, stock, price })
  });

  itemName.value = "";
  itemStock.value = "";
  itemPrice.value = "";
  loadAdmin();
}

/* ================= DELETE ITEM ================= */
async function deleteItem(key) {
  await fetch(`/admin/delete-item/${key}`, {
    method: "DELETE",
    headers: { Authorization: token }
  });
  loadAdmin();
}

/* ================= RESET ================= */
async function resetLogs() {
  if (!confirm("Clear all logs and reset stocks?")) return;

  await fetch("/admin/reset-logs", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    }
  });

  loadAdmin();
}

/* ================= LOGOUT ================= */
async function logout() {
  await fetch("/logout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token })
  });

  localStorage.clear();
  window.location.href = "login.html";
}

/* ================= ORDERS ================= */
async function loadOrders() {
  if (isEditing) return;

  const res = await fetch("/admin/orders", {
    headers: { Authorization: token }
  });

  const orders = await res.json();
  const container = document.getElementById("orders");
  container.innerHTML = "";

  if (orders.length === 0) {
    container.innerHTML = "<p>No orders yet</p>";
    return;
  }

  orders.forEach(o => {
    let html = `
      <div style="border:1px solid #ddd; padding:12px; margin-bottom:12px;">
        <strong>${o.customer?.email || "Unknown"}</strong><br>
        <small>${o.time}</small><br><br>
        <ul>
    `;

    o.items?.forEach(i => {
      html += `<li>${i.name} √ó ${i.qty} = ‚Çπ${i.subtotal}</li>`;
    });

    html += `
        </ul>
        <strong>Total: ‚Çπ${o.totalAmount}</strong>
      </div>
    `;

    container.innerHTML += html;
  });
}

/* ================= INIT ================= */
function initChart() {
  const ctx = document.getElementById("stockChart").getContext("2d");

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Stock",
        data: [],
        backgroundColor: "#3ec6c6",
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      animation: {
        duration: 1200,
        easing: "easeInOutQuart"
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

initChart();
loadAdmin();
loadOrders();
setInterval(loadAdmin, 3000);
setInterval(loadOrders, 4000);
</script>

<!-- üîî Toast Notification -->
<div id="toast" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #ff4d4d;
  color: white;
  padding: 14px 18px;
  border-radius: 8px;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  display: none;
  z-index: 9999;
"></div>

</body>
</html>
