<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* üîî TOAST CONTAINER */
    #toastContainer {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
    }

    .toast {
      background: #dc2626;
      color: white;
      padding: 14px 18px;
      margin-top: 10px;
      border-radius: 8px;
      font-weight: bold;
      min-width: 260px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.2s forwards;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    @keyframes slideIn {
      from { transform: translateX(120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(120%); }
    }
  </style>
</head>

<body class="admin-body">

<div class="admin-header">
  <h1>üìä Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- üîî TOAST AREA -->
<div id="toastContainer"></div>

<div class="admin-container">

  <!-- ADD ITEM -->
  <div class="card">
    <h2>‚ûï Add Item</h2>
    <input id="itemName" placeholder="Item name">
    <input id="itemStock" type="number" placeholder="Initial stock">
    <input id="itemPrice" type="number" placeholder="Price">
    <button onclick="addItem()">Add Item</button>
  </div>

  <!-- INVENTORY -->
  <div class="card">
    <h2>üì¶ Inventory</h2>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Stock</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>
  </div>

  <!-- STOCK GRAPH -->
  <div class="card">
    <h2>üìà Stock Graph</h2>
    <canvas id="stockChart"></canvas>
  </div>

  <!-- ANALYTICS -->
  <div class="card">
    <h2>üí∞ Revenue Analytics</h2>
    <p>Total Revenue: ‚Çπ<span id="totalRevenue">0</span></p>
    <p>Total Orders: <span id="totalOrders">0</span></p>
    <canvas id="revenueChart"></canvas>
  </div>

  <button class="danger-btn" onclick="resetLogs()">üßπ Reset Logs & Stocks</button>

  <div class="card">
    <h2>ü§ñ Forecasting Logs</h2>
    <ul id="forecastingLogs"></ul>
  </div>

  <div class="card">
    <h2>üîç Monitoring Logs</h2>
    <ul id="monitoringLogs"></ul>
  </div>

  <div class="card">
    <h2>üßæ Orders</h2>
    <div id="orders"></div>
  </div>

</div>

<script>
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
if (!token || role !== "admin") location.href = "login.html";

const inventoryTable = document.getElementById("inventoryTable");
const toastContainer = document.getElementById("toastContainer");

let stockChart, revenueChart;

/* ================= TOAST ================= */
function showToast(msg) {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerHTML = `‚ö†Ô∏è ${msg}`;
  toastContainer.appendChild(t);
  setTimeout(() => t.remove(), 2500);
}

/* ================= CHARTS ================= */
function initCharts() {
  stockChart = new Chart(document.getElementById("stockChart"), {
    type: "bar",
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: { plugins: { legend: { display: false } } }
  });

  revenueChart = new Chart(document.getElementById("revenueChart"), {
    type: "line",
    data: { labels: [], datasets: [{ data: [], borderColor: "#3ec6c6" }] }
  });
}

/* ================= LOAD ADMIN ================= */
async function loadAdmin() {
  const res = await fetch("/admin-data", { headers: { Authorization: token }});
  const d = await res.json();

  renderInventory(d.inventory);
  renderStockChart(d.inventory);
  renderLogs(d.monitoring, "monitoringLogs");
  renderLogs(d.forecasting, "forecastingLogs");

  d.inventory.forEach(i => {
    if (i.stock <= 3) {
      showToast(`${i.name} is LOW (${i.stock})`);
    }
  });
}

/* ================= INVENTORY ================= */
function renderInventory(items) {
  inventoryTable.innerHTML = "";
  items.forEach(i => {
    inventoryTable.innerHTML += `
      <tr>
        <td>${i.name}</td>
        <td><input value="${i.stock}" type="number"
          onblur="updateStock('${i.key}', this.value)"></td>
        <td><input value="${i.price}" type="number"
          onblur="updatePrice('${i.key}', this.value)"></td>
        <td><button class="delete-btn" onclick="deleteItem('${i.key}')">‚úñ</button></td>
      </tr>`;
  });
}

/* ================= GRAPH ================= */
function renderStockChart(items) {
  stockChart.data.labels = items.map(i => i.name);
  stockChart.data.datasets[0].data = items.map(i => i.stock);
  stockChart.data.datasets[0].backgroundColor =
    items.map(i => i.stock <= 3 ? "#dc2626" : "#60a5fa");
  stockChart.update();
}

/* ================= HELPERS ================= */
function renderLogs(logs, id) {
  document.getElementById(id).innerHTML =
    logs.length ? logs.map(l =>
      `<li>${l.item} ‚Üí ${l.stock}<br><small>${l.time}</small></li>`
    ).join("") : "<li>No logs</li>";
}

/* ================= ACTIONS ================= */
async function updateStock(key, stock) {
  await fetch("/admin/update-stock", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ key, stock: Number(stock) })
  });
}

async function updatePrice(key, price) {
  await fetch("/admin/update-price", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ key, price: Number(price) })
  });
}

async function addItem() {
  await fetch("/admin/add-item", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({
      name: itemName.value,
      stock: Number(itemStock.value),
      price: Number(itemPrice.value)
    })
  });
}

async function deleteItem(key) {
  await fetch(`/admin/delete-item/${key}`, {
    method: "DELETE",
    headers: { Authorization: token }
  });
}

async function resetLogs() {
  await fetch("/admin/reset-logs", {
    method: "POST",
    headers: { Authorization: token }
  });
}

async function logout() {
  await fetch("/logout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token })
  });
  localStorage.clear();
  location.href = "login.html";
}

/* ================= START ================= */
initCharts();
loadAdmin();
setInterval(loadAdmin, 3000);
</script>

</body>
</html>
