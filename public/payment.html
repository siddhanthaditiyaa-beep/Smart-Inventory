<!DOCTYPE html>
<html>
<head>
  <title>Payment | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container" style="max-width:500px;text-align:center;">
  <h1>ðŸ’³ Secure Payment</h1>

  <h3>Order Summary</h3>
  <ul id="summary"></ul>

  <h2>Total: â‚¹<span id="total">0</span></h2>

  <div id="actionArea">
    <button onclick="pay()">Pay Now</button>
  </div>
</div>

<script>
/* ================= AUTH CHECK ================= */
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");

if (!token || role !== "customer") {
  alert("Session expired. Please login again.");
  location.href = "login.html";
}

/* ================= CART ================= */
const cart = JSON.parse(localStorage.getItem("pendingCart") || "{}");
const summary = document.getElementById("summary");
const totalEl = document.getElementById("total");
const actionArea = document.getElementById("actionArea");

let total = 0;

/* ================= LOAD SUMMARY ================= */
async function loadSummary() {
  if (Object.keys(cart).length === 0) {
    summary.innerHTML = "<li>Your cart is empty</li>";
    return;
  }

  const res = await fetch("/shop-items", {
    headers: { Authorization: token }
  });

  const items = await res.json();

  summary.innerHTML = "";
  total = 0;

  Object.keys(cart).forEach(key => {
    const item = items[key];
    if (!item) return;

    const cost = item.price * cart[key];
    total += cost;

    summary.innerHTML += `
      <li>${item.name} Ã— ${cart[key]} = â‚¹${cost}</li>
    `;
  });

  totalEl.innerText = total;
}

loadSummary();

/* ================= PAYMENT ================= */
async function pay() {
  if (total === 0) {
    alert("Cart is empty");
    return;
  }

  actionArea.innerHTML = `<p>Processing payment...</p>`;

  const res = await fetch("/checkout", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ cart })
  });

  if (!res.ok) {
    actionArea.innerHTML = `
      <p style="color:red;">Payment failed</p>
      <button onclick="location.reload()">Retry</button>
    `;
    return;
  }

  localStorage.removeItem("pendingCart");

  actionArea.innerHTML = `
    <h2 style="color:green;">âœ… Payment Successful</h2>
  `;

  setTimeout(() => {
    location.href = "customer.html";
  }, 1500);
}
</script>

</body>
</html>
