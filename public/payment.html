<!DOCTYPE html>
<html>
<head>
  <title>Payment | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .loader {
      width: 36px;
      height: 36px;
      border: 4px solid #ddd;
      border-top: 4px solid #3ec6c6;
      border-radius: 50%;
      margin: 12px auto;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success {
      color: green;
      animation: pop 0.4s ease;
    }

    .failure {
      color: red;
      animation: shake 0.35s;
    }

    @keyframes pop {
      0% { transform: scale(0.7); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-6px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>

<body>

  <button class="dark-toggle" onclick="toggleDarkMode()">üåô</button>

<div class="container" style="max-width:500px; text-align:center;">
  <h1>üí≥ Secure Payment</h1>

  <h3>Order Summary</h3>
  <ul id="summary"></ul>

  <h2>Total: ‚Çπ<span id="total">0</span></h2>

  <!-- ACTION AREA -->
  <div id="actionArea">
    <button id="payBtn" onclick="pay()">Pay Now</button>
  </div>

  <p id="msg" style="margin-top:16px;"></p>
</div>

<script>
/* =========================
   üîê SESSION CHECK
========================= */
const role = localStorage.getItem("role");
const token = localStorage.getItem("token");

if (!token || role !== "customer") {
  window.location.href = "login.html";
}

/* =========================
   CART DATA
========================= */
const cart = JSON.parse(localStorage.getItem("pendingCart")) || {};
const summary = document.getElementById("summary");
const totalEl = document.getElementById("total");
const actionArea = document.getElementById("actionArea");

let total = 0;

/* =========================
   LOAD SUMMARY
========================= */
async function loadSummary() {
  const res = await fetch("/shop-items", {
    headers: { Authorization: token }
  });

  const items = await res.json();

  if (Object.keys(cart).length === 0) {
    summary.innerHTML = "<li>Your cart is empty</li>";
    return;
  }

  Object.keys(cart).forEach(key => {
    const item = items[key];
    if (!item) return;

    const cost = item.price * cart[key];
    total += cost;

    summary.innerHTML += `
      <li>${item.name} √ó ${cart[key]} = ‚Çπ${cost}</li>
    `;
  });

  totalEl.innerText = total;
}

loadSummary();

/* =========================
   PAYMENT FLOW (RAZORPAY STYLE)
========================= */
async function pay() {
  if (Object.keys(cart).length === 0) return;

  actionArea.innerHTML = `
    <div class="loader"></div>
    <p>Processing payment‚Ä¶</p>
  `;

  setTimeout(async () => {
    const isSuccess = Math.random() > 0.25; // 75% success

    if (!isSuccess) {
      showFailure();
      return;
    }

    const res = await fetch("/checkout", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token
      },
      body: JSON.stringify({ cart })
    });

    if (res.ok) {
      showSuccess();
      localStorage.removeItem("pendingCart");

      setTimeout(() => {
        window.location.href = "customer.html";
      }, 2000);
    } else {
      showFailure();
    }

  }, 1800);
}

/* =========================
   UI STATES
========================= */
function showSuccess() {
  actionArea.innerHTML = `
    <div class="success">
      <div style="font-size:64px;">‚úî</div>
      <h2>Payment Successful</h2>
    </div>
  `;
}

function showFailure() {
  actionArea.innerHTML = `
    <div class="failure">
      <div style="font-size:64px;">‚úñ</div>
      <h2>Payment Failed</h2>
      <button onclick="retry()">Retry Payment</button>
    </div>
  `;
}

function retry() {
  location.reload();
}
</script>

<script>
function toggleDarkMode() {
  document.body.classList.toggle("dark");

  if (document.body.classList.contains("dark")) {
    localStorage.setItem("darkMode", "on");
  } else {
    localStorage.setItem("darkMode", "off");
  }
}

window.onload = () => {
  if (localStorage.getItem("darkMode") === "on") {
    document.body.classList.add("dark");
  }
};
</script>

</body>
</html>
