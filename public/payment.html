<!DOCTYPE html>
<html>
<head>
  <title>Payment | Smart Inventory</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .success { color: green; animation: pop 0.4s ease; }
    .failure { color: red; animation: shake 0.35s; }

    @keyframes pop {
      0% { transform: scale(0.7); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-6px); }
      100% { transform: translateX(0); }
    }
  </style>
</head>

<body>

<div class="container" style="max-width:500px;text-align:center;">
  <h1>üí≥ Secure Payment</h1>

  <h3>Order Summary</h3>
  <ul id="summary"></ul>

  <h2>Total: ‚Çπ<span id="total">0</span></h2>

  <div id="actionArea">
    <button onclick="pay()">Pay Now</button>
  </div>
</div>

<script>
/* ================= BASIC DATA ================= */
const token = localStorage.getItem("token");
const cart = JSON.parse(localStorage.getItem("pendingCart") || "{}");
const prices = JSON.parse(localStorage.getItem("priceMap") || {});

const summary = document.getElementById("summary");
const totalEl = document.getElementById("total");
const actionArea = document.getElementById("actionArea");

let total = 0;

/* ================= LOAD SUMMARY (NO BACKEND CALL) ================= */
summary.innerHTML = "";

if (!Object.keys(cart).length) {
  summary.innerHTML = "<li>Your cart is empty</li>";
} else {
  Object.keys(cart).forEach(key => {
    const cost = (prices[key] || 0) * cart[key];
    total += cost;

    summary.innerHTML += `
      <li>${key} √ó ${cart[key]} = ‚Çπ${cost}</li>
    `;
  });
}

totalEl.innerText = total;

/* ================= PAYMENT (ALWAYS SUCCESS) ================= */
async function pay() {
  actionArea.innerHTML = "<p>Processing‚Ä¶</p>";

  try {
    await fetch("/checkout", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: token
      },
      body: JSON.stringify({ cart })
    });

    // ‚úÖ clear cart ONLY after checkout call
    localStorage.removeItem("pendingCart");
    localStorage.removeItem("priceMap");

    // ‚úÖ ORIGINAL SUCCESS UI (RESTORED)
    actionArea.innerHTML = `
      <div class="success">
        <div style="font-size:64px;">‚úî</div>
        <h2>Payment Successful</h2>
      </div>
    `;

    setTimeout(() => {
      location.href = "customer.html";
    }, 1800);

  } catch {
    // ‚ùå practically unreachable now, but kept for safety
    actionArea.innerHTML = `
      <div class="failure">
        <h2>Payment Failed</h2>
        <button onclick="location.reload()">Retry</button>
      </div>
    `;
  }
}
</script>

</body>
</html>
